{% extends "layouts/main.html" %}

{% from "components/service-header/macro.njk" import serviceHeader %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}

{% set pageName = "Conditional Logic Task" %}

{% block header %}
{{ serviceHeader({
organisationName: "Defra",
productName: "Forms designer",
serviceName: "",
accountName: "Chris Smith",
homepageLink: "/",
signOutLink: "/titan-mvp-1.2/onboarding/sign-out-confirmation",
navigationItems: [{
href: "/titan-mvp-1.2/library",
text: "Library",
id: "titan-mvp-1.2/library"
}]
}) }}

<div class="x-govuk-masthead x-govuk-masthead--large">
    <div class="govuk-width-container">
        {{ govukBackLink({
        classes: "govuk-back-link--inverse govuk-!-margin-bottom-0",
        text: "Back to task list",
        href: "/titan-mvp-1.2/ai/tasklist-form-creation"
        }) }}

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible"
            style="border-bottom: 1px solid white; margin-bottom: 0" />

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full-from-desktop">
                <h1 class="x-govuk-masthead__title">
                    <span class="govuk-caption-l" style="color: white;">AI form creation
                    </span>
                    Page conditions
                </h1>
                <p class="x-govuk-masthead__description">
                    Describe any conditional logic or branching rules for your form. This helps the AI understand when
                    certain pages or fields should be shown or hidden.
                </p>

            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">



        <form class="form" action="/titan-mvp-1.2/ai/task/conditional-logic" method="post">

            {{ govukTextarea({
            id: "conditional-logic",
            name: "conditionalLogic",
            label: {
            text: "Describe any page conditions you think are relevant to your form",
            classes: "govuk-label--l",
            isPageHeading: false
            },
            hint: {
            text: "For example, if user is under 18 they can't apply for a business licence."
            },
            rows: 10,
            value: data.conditionalLogic
            }) }}

            {{ govukDetails({
            summaryText: "Examples",
            html: "
            <h2 class='govuk-heading-m'><strong>Show page based on answer:</strong></h2>
            <p class='govuk-body'>Only show the disability details page if the user answered \"Yes\" to \"Do you have a
                disability?\" on the previous page.</p>

            <h2 class='govuk-heading-m'><strong>Show page based on age:</strong></h2>
            <p class='govuk-body'>Only show the parent/guardian consent page if the user is under 18 years old (based on
                their date of birth answer).</p>

            <h2 class='govuk-heading-m'><strong>Show page based on location:</strong></h2>
            <p class='govuk-body'>Only show the England-specific requirements page if the user selected \"England\" as
                their location on the previous page.</p>
            </ul>
            "
            }) }}


            <div class="govuk-!-margin-top-6">
                {{ govukRadios({
                name: "haveYouCompletedThisSection",
                fieldset: {
                legend: {
                text: "Have you completed this section?",
                isPageHeading: false,
                classes: "govuk-fieldset__legend--m"
                }
                },
                items: [
                {
                value: "yes",
                text: "Yes, I've completed this section"
                },
                {
                value: "no",
                text: "No, I'll come back to it later"
                }
                ]
                }) }}
            </div>

            <div class="govuk-!-margin-top-6">
                <div class="govuk-button-group">
                    {{ govukButton({
                    text: "Continue",
                    classes: "govuk-button"
                    }) }}
                </div>
            </div>

        </form>
    </div>


</div>

<style>
    .govuk-sticky {
        position: sticky;
        top: 20px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle form submission based on radio selection
        const form = document.querySelector('form');
        const continueButton = document.querySelector('button[type="submit"]');

        continueButton.addEventListener('click', function (e) {
            e.preventDefault();

            const selectedOption = document.querySelector('input[name="haveYouCompletedThisSection"]:checked');

            if (selectedOption && selectedOption.value === 'no') {
                // If "No, I'll come back to it later" is selected, save as incomplete and redirect
                const formData = new FormData(form);
                formData.append('taskStatus', 'incomplete');
                formData.append('returnToTaskList', 'true');

                // Create a temporary form to submit
                const tempForm = document.createElement('form');
                tempForm.method = 'POST';
                tempForm.action = form.action;

                for (let [key, value] of formData.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    tempForm.appendChild(input);
                }

                document.body.appendChild(tempForm);
                tempForm.submit();
            } else if (selectedOption && selectedOption.value === 'yes') {
                // If "Yes, I've completed this section" is selected, save as completed
                const formData = new FormData(form);
                formData.append('taskStatus', 'completed');

                // Create a temporary form to submit
                const tempForm = document.createElement('form');
                tempForm.method = 'POST';
                tempForm.action = form.action;

                for (let [key, value] of formData.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    tempForm.appendChild(input);
                }

                document.body.appendChild(tempForm);
                tempForm.submit();
            } else {
                // If no option is selected, submit the form normally
                form.submit();
            }
        });
    });
</script>
{% endblock %}