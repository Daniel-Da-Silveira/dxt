{% extends "layouts/runner.html" %}
{% from "components/declaration-checkboxes/macro.njk" import declarationCheckboxes %}


{% block pageTitle %}
Declaration – {{ serviceName }} – GOV.UK
{% endblock %}



{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

    {% if error %}
      {{ govukErrorSummary({
        titleText: "There is a problem",
        errorList: [
          {
            text: error.declarationError,
            href: "#declaration-checkbox"
          } if error.declarationError else ""
        ]
      }) }}
    {% endif %}

    <form class="form" action="/declaration" method="post">

      {{ declarationCheckboxes({
        name: "declaration",
        fieldset: {
        legend: {
        text: "Declaration",
        isPageHeading: true }
        },
        hint: {
        text: ""
        },
        content: {
        html: "<p>I confirm that:</p>
        <ul class='govuk-list govuk-list--bullet'>
          <li>I own a real unicorn and not just a horse with a cone on its head</li>
          <li>I understand the importance of keeping the unicorn safe and healthy and not letting it escape</li>
          <li>I accept responsibility for any false statements and any consequences of my actions</li>
        </ul>
        <p>You must agree to this declaration to legally own unicorns.</p>"
        },
        errorMessage: {
        text: error.declarationError
        } if error.declarationError else "",
        items: [
        {
        value: "confirmed",
        text: "I understand and agree",
        id: "declaration-checkbox"
        }
        ]
        }) }}


      <div class="govuk-button-group">
      {{ govukButton({
          text: "Continue"
        }) }}

        {{ govukButton({
          text: "Save and exit",
          classes: "govuk-button--secondary",
          href: "/save-progress",
          type: "button",
          attributes: {
            "data-save-exit": "true"
          }
        }) }}
      </div>

    </form>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const saveExitButton = document.querySelector('[data-save-exit="true"]');

  if (saveExitButton) {
    saveExitButton.addEventListener('click', function(e) {
      e.preventDefault();

      // Validate required fields
      const declarationCheckbox = document.querySelector('input[name="declaration"]');
      const isChecked = declarationCheckbox ? declarationCheckbox.checked : false;

      if (!isChecked) {
        // Show error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'govuk-error-message';
        errorMessage.innerHTML = '<span class="govuk-visually-hidden">Error:</span>You must confirm that you understand and agree';

        // Remove any existing error messages
        const existingError = document.querySelector('.govuk-error-message');
        if (existingError) {
          existingError.remove();
        }

        // Add error message above the checkbox
        const formGroup = declarationCheckbox.closest('.govuk-form-group');
        if (formGroup) {
          formGroup.classList.add('govuk-form-group--error');
          declarationCheckbox.classList.add('govuk-checkboxes__input--error');
          formGroup.insertBefore(errorMessage, declarationCheckbox);
        }

        // Focus on the checkbox
        declarationCheckbox.focus();
        return;
      }

      // Get the current page URL
      const currentUrl = window.location.pathname;

      // Redirect to save-progress with the current page as returnUrl
      window.location.href = '/save-progress?returnUrl=' + encodeURIComponent(currentUrl);
    });
  }
});
</script>

{% endblock %}
