{% extends "layouts/main.html" %}
{# {% set containerClasses = "app-width-container--full-width" %} #}

{% from "components/service-header/macro.njk" import serviceHeader %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}

{% set pageName = "Add and edit your pages - " + form.name %}

{% block header %}
{{ serviceHeader({
organisationName: "Defra",
productName: "Form Designer",
serviceName: "",
containerClasses: containerClasses,
accountName: "Chris Smith",
homepageLink: "/",
signOutLink: "/titan-mvp-1.2/onboarding/sign-out-confirmation",
navigationItems: [
{ href: "/titan-mvp-1.2/library", text: "Forms library", id: "nav-library" },
{ href: "/titan-mvp-1.2/form-overview/index.html", text: "Overview", id: "nav-overview" },
{ href: "/titan-mvp-1.2/form-editor/listing", text: "Editor", id: "nav-editor", active: true }
],
activeLinkId: "nav-editor"
}) }}


<div class="x-govuk-masthead x-govuk-masthead--large  x-govuk-masthead--inverse">
    <div class="govuk-width-container">

        {{ govukBackLink({
        classes: "govuk-back-link--inverse govuk-!-margin-bottom-0",
        text: "Back to overview",
        href: "/titan-mvp-1.2/form-overview/index.html"
        }) }}

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible"
            style="border-bottom:1px solid white; margin-bottom: 0;">

        <h1 class="govuk-heading-l--inverse x-govuk-masthead__title">
            <span class="govuk-caption-l" style="color: white;">{{ form.name }}
            </span>
            Add and edit pages
        </h1>

        <div class="govuk-button-group">
            <a href="/titan-mvp-1.2/form-editor/page-type.html" role="button" draggable="false"
                class="govuk-button govuk-button--inverse" data-module="govuk-button">
                Add new page
            </a>

            <a href="/titan-mvp-1.2/form-editor/reorder/main.html" role="button" draggable="false"
                class="govuk-button govuk-button--secondary" id="reorder-button" data-module="govuk-button"
                style="display: none;">
                Re-order pages
            </a>

            <a href="#" class="govuk-link govuk-link--inverse" id="preview-link" style="display: inline-block;">
                Preview form
            </a>
        </div>

    </div>
</div>
{% endblock %}

{% block content %}



<style>
    .guidance-card {
        border-left: 10px solid #b1b4b6;
    }

    .question-card {
        border-left: 10px solid #008938;
    }

    .payment-summary-wrap {
        border: 1px solid #b1b4b6;
        border-radius: 4px;
        overflow: hidden;
    }

    .payment-summary {
        border-top: 2px solid #1d70b8;
        padding: 15px;
        background-color: #f3f2f1;
    }

    @media all{
        .amount  {
            display: block;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const applyFiltersButton = document.getElementById('apply-filters');
        const selectedFilters = document.getElementById('selected-filters');
        const filterSummary = document.getElementById('filter-summary');
        const pageCards = document.querySelectorAll('.app-page-card');
        const pagesCountElement = document.getElementById('pages-count');

        if (!applyFiltersButton) {
            console.error('Filter button not found');
            return;
        }

        function updatePages() {
            // Get all checked checkboxes
            const checkedFilters = document.querySelectorAll('input[name="condition-filter"]:checked');
            const selectedConditions = Array.from(checkedFilters).map(cb => cb.value);

            // Show/hide the filter summary
            if (selectedConditions.length > 0) {
                filterSummary.innerHTML = selectedConditions.map(condition =>
                    `<li>${condition}</li>`
                ).join('');
                selectedFilters.style.display = 'block';
            } else {
                selectedFilters.style.display = 'none';
                filterSummary.innerHTML = '';
            }

            // Update visibility of page cards
            let visiblePages = 0;
            let foundExitPage = false;

            pageCards.forEach(card => {
                const cardConditions = (card.dataset.conditions || '').split(',').filter(Boolean);
                const isExitPage = card.querySelector('.govuk-tag--pink') !== null;

                // Only apply exit page logic when filters are selected
                if (selectedConditions.length > 0) {
                    // Check if this exit page's conditions are met
                    const exitPageConditionsMet = isExitPage && (
                        cardConditions.length === 0 ||
                        selectedConditions.some(condition => cardConditions.includes(condition))
                    );

                    // If we've found an exit page with conditions met, hide all subsequent pages
                    if (foundExitPage) {
                        card.style.display = 'none';
                        return;
                    }

                    // Mark that we've found an exit page with conditions met
                    if (exitPageConditionsMet) {
                        foundExitPage = true;
                    }
                }

                // Show the card if:
                // 1. No conditions are selected (show all), OR
                // 2. The card has no conditions (always show), OR
                // 3. The card has one of the selected conditions
                const shouldShow = selectedConditions.length === 0 ||
                    cardConditions.length === 0 ||
                    selectedConditions.some(condition => cardConditions.includes(condition));

                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visiblePages++;
            });

            // Update the pages count heading
            if (pagesCountElement) {
                pagesCountElement.textContent = selectedConditions.length > 0 ? visiblePages : pageCards.length;
            }
        }

        // Handle filter button click
        applyFiltersButton.addEventListener('click', function (e) {
            e.preventDefault();
            updatePages();
        });

        // Add event listener for clear filters button
        const clearFiltersButton = document.querySelector('.govuk-button--secondary');
        if (clearFiltersButton) {
            clearFiltersButton.addEventListener('click', function (e) {
                e.preventDefault();
                // Uncheck all checkboxes
                document.querySelectorAll('input[name="condition-filter"]').forEach(cb => cb.checked = false);
                updatePages();
            });
        }

        // Initial update to show all pages
        updatePages();
    });
</script>

<div class="govuk-grid-row">
    {% set hasConditions = false %}
    {% for page in formPages %}
    {% if page.conditions and page.conditions.length > 0 %}
    {% set hasConditions = true %}
    {% endif %}
    {% endfor %}

    {% if hasConditions %}
    <!-- Left column for filters -->
    <div class="govuk-grid-column-one-quarter">
        <div id="selected-filters" class="govuk-inset-text govuk-!-margin-top-2" style="display: none;">
            <h3 id="applied-filters-heading" class="govuk-heading-s">Applied filters:</h3>
            <ul class="govuk-list govuk-list--bullet govuk-list--spaced" id="filter-summary">
            </ul>
        </div>

        <aside id="search-filters" aria-describedby="search-filters-heading" class="app-search__filters">
            {% set uniqueConditions = [] %}
            {% for page in formPages %}
            {% if page.conditions %}
            {% for condition in page.conditions %}
            {% if condition.conditionName not in uniqueConditions %}
            {% set uniqueConditions = (uniqueConditions.push(condition.conditionName), uniqueConditions) %}
            {% endif %}
            {% endfor %}
            {% endif %}
            {% endfor %}

            {# Build full list of condition names defined in the form (if provided via data.conditions) #}
            {% set allConditionNames = [] %}
            {% if data and data.conditions %}
            {% for cond in data.conditions %}
            {% set condName = cond.name or cond.conditionName %}
            {% if condName and (condName not in allConditionNames) %}
            {% set allConditionNames = (allConditionNames.push(condName), allConditionNames) %}
            {% endif %}
            {% endfor %}
            {% endif %}

            {# Compute conditions that are defined but not assigned to any page #}
            {% set unassignedConditions = [] %}
            {% for name in allConditionNames %}
            {% if name not in uniqueConditions %}
            {% set unassignedConditions = (unassignedConditions.push(name), unassignedConditions) %}
            {% endif %}
            {% endfor %}

            {% if uniqueConditions.length > 0 %}
            <h2 id="search-filters-heading" class="govuk-heading-m govuk-!-margin-bottom-4">Filter pages by condition
            </h2>

            <div id="search-buttons--header" class="govuk-button-group govuk-!-margin-bottom-4">
                {{ govukButton({ text: "Apply filters", id: "apply-filters" }) }}
                {{ govukButton({
                text: "Clear filters",
                href: "?page=1&name=&author=&organisation=&status=&sort=updated-newest",
                classes: "govuk-button--secondary"
                }) }}
            </div>

            <div aria-labelledby="applied-filters-heading">
                <h3 id="applied-filters-heading" style="display: none;" class="govuk-heading-s">Applied filters:</h3>

                {# Initialize items array with condition items #}
                {% set items = [] %}
                {% for condition in uniqueConditions %}
                {% set items = (items.push({
                value: condition,
                text: condition
                }), items) %}
                {% endfor %}

                {{ govukCheckboxes({
                idPrefix: "condition-filter",
                name: "condition-filter",
                classes: "govuk-checkboxes--small",
                items: items
                }) }}
            </div>

            <div id="search-buttons--header" class="govuk-button-group govuk-!-margin-bottom-4">
                {{ govukButton({ text: "Apply filters", id: "apply-filters" }) }}
                {{ govukButton({
                text: "Clear filters",
                href: "?page=1&name=&author=&organisation=&status=&sort=updated-newest",
                classes: "govuk-button--secondary"
                }) }}
            </div>
            {% endif %}
            {%- from "moj/components/button-menu/macro.njk" import mojButtonMenu -%}

            {# Show non-assigned conditions as a non-bulleted list at the bottom #}
            {% if unassignedConditions.length > 0 %}
            <div class="govuk-!-margin-top-4" aria-labelledby="unassigned-filters-heading">
                <h3 id="unassigned-filters-heading" class="govuk-heading-m">Conditions not applied to pages</h3>
                <ul class="govuk-list govuk-list--bullet govuk-list--spaced">
                    {% for condition in unassignedConditions %}
                    <li class="govuk-hint">{{ condition }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}


        </aside>
    </div>



    <!-- Right column for main content when there are conditions -->
    <div class="govuk-grid-column-three-quarters">
        {% else %}
        <!-- Full width main content when there are no conditions -->
        <div class="govuk-grid-column-full">
            {% endif %}

            <!-- Right column for pages -->
            {# <div
                class="govuk-grid-column-three-quarters-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full">
                #}
                {# {% if formPages.length %} #}
                <div class="govuk-grid-row">
                    <div
                        class="govuk-grid-column-full-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full">

                        {% if data.showUploadSuccess %}
                        <div class="govuk-grid-row" id="success-notification">
                            <div class="govuk-grid-column-one-half">
                                {{ govukNotificationBanner({
                                type: "success",
                                text: "Form uploaded successfully",
                                titleText: "Success",
                                classes: "govuk-!-margin-bottom-4"
                                }) }}
                            </div>
                        </div>

                        <script>
                            // Hide the notification after 15 seconds
                            setTimeout(function () {
                                const notification = document.getElementById('success-notification');
                                if (notification) {
                                    notification.style.display = 'none';
                                }
                            }, 15000);
                        </script>
                        {% endif %}

                        {% if request.query.pageOrderUpdated %}
                        <div class="govuk-grid-row" id="page-order-success-notification">
                            <div class="govuk-grid-column-one-third">
                                {{ govukNotificationBanner({
                                type: "success",
                                text: "Page order updated successfully",
                                titleText: "Success",
                                classes: "govuk-!-margin-bottom-4"
                                }) }}
                            </div>
                        </div>

                        <script>
                            // Hide the notification after 10 seconds
                            setTimeout(function () {
                                const notification = document.getElementById('page-order-success-notification');
                                if (notification) {
                                    notification.style.display = 'none';
                                }
                            }, 10000);
                        </script>
                        {% endif %}

                        {% if formPages.length > 0 %}
                        <h2 class="govuk-heading-m" id="pages-count-heading">
                            <span class="govuk-visually-hidden">pages</span>
                            <span id="pages-count">{{ formPages.length }}</span>
                            {% if formPages.length == 1 %}page{% else %}pages{% endif %}
                            {% else %}
                            <h2 class="govuk-heading-m" id="pages-count-heading"></h2>
                            {% endif %}

                            <div style="float: right;">

                                <input type="file" id="form-upload" style="display: none;"
                                    accept=".json,.xlsx,.xls,.csv">
                                <input type="file" id="form-download" style="display: none;"
                                    accept=".json,.xlsx,.xls,.csv">

                                {%- from "moj/components/button-menu/macro.njk" import mojButtonMenu -%}

                                {{ mojButtonMenu({
                                button: {
                                text: "Tools",
                                classes: "govuk-button--secondary"
                                },
                                alignMenu: "right",
                                items: [
                                {
                                text: "Manage conditions",
                                href: "/titan-mvp-1.2/form-editor/conditions/manager",
                                attributes: {
                                "onclick": "return true;"
                                }
                                },
                                {
                                text: "Upload form",
                                href: "/titan-mvp-1.2/form-editor/upload-confirmation",
                                attributes: {
                                "onclick": "return true;"
                                }
                                },
                                {
                                text: "Download form",
                                href: "#",
                                attributes: {
                                "onclick": "downloadForm(); return false;"
                                }
                                }
                                ]
                                }) }}
                            </div>
                            {% if formPages.length > 0 %}
                            <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                            {% endif %}
                        </h2>

                    </div>
                </div>

                <!-- Rest of your content goes here -->
                {% if formPages.length %}
                {% for page in formPages %}
                {% if page.questions and page.questions.length > 0 or page.pageType == 'guidance' %}
                {% set hasPaymentQuestions = false %}
                {% if page.questions %}
                {% for question in page.questions %}
                {% if question.type === "payment" %}
                {% set hasPaymentQuestions = true %}
                {% endif %}
                {% endfor %}
                {% endif %}
                {% if page.pageHeading and page.pageHeading.toLowerCase().includes("payment") %}
                {% set hasPaymentQuestions = true %}
                {% endif %}
                {% if not hasPaymentQuestions %}
                <div class="app-page-card"
                    data-conditions="{% for condition in page.conditions %}{{ condition.conditionName }}{% if not loop.last %},{% endif %}{% endfor %}">
                    <div class="govuk-grid-row">
                        <!-- Left Column: Summary Card -->
                        <div
                            class="govuk-grid-column-one-half-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full-from-mobile">
                            <div class="govuk-summary-card govuk-!-margin-bottom-4" {% if page.isExitPage %}
                                style="border-left: 10px solid #6b1c40;" {% else %}
                                style="border-left: 10px solid #008938;" {% endif %}>
                                <div class="govuk-summary-card__title-wrapper"
                                    style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        {% if page.isExitPage or page.section %}
                                        <div class="govuk-button-group"
                                            style="margin-bottom: 10px; margin-right: 10px!important;">
                                            {% if page.isExitPage %}
                                            <span class="govuk-tag govuk-tag--pink" style="margin-right: 10px;">Exit
                                                page</span>
                                            {% endif %}
                                            {% if page.section %}
                                            <span class="govuk-tag govuk-tag--green">
                                                {{ page.section.name }}</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        <h2 class="govuk-summary-card__title" style="margin: 0;">
                                            Page {{ loop.index }}:
                                            {% if page.pageType == 'guidance' %}
                                            {{ page.guidanceOnlyHeadingInput }}
                                            {% else %}
                                            {% if page.pageHeading %}
                                            {{ page.pageHeading }}
                                            {% elif page.questions and page.questions.length == 1 %}
                                            {{ page.questions[0].label }}
                                            {% else %}
                                            {{ page.pageType | capitalize }}
                                            {% endif %}
                                            {% endif %}
                                        </h2>
                                    </div>
                                    <ul class="govuk-summary-card__actions" style="margin: 0; padding-left: 15px;">
                                        <li class="govuk-summary-card__action"
                                            style="display: inline-block; margin-right: 10px;">
                                            <a class="govuk-link govuk-link--no-visited-state" href="{% if page.pageType == 'guidance' %}
                                        /titan-mvp-1.2/form-editor/edit-guidance?pageId={{ page.pageId }}
                                    {% else %}
                                        /titan-mvp-1.2/edit-page/{{ page.pageId }}
                                    {% endif %}">
                                                Edit<span class="govuk-visually-hidden"> page {{
                                                    page.pageId }}</span>
                                            </a>
                                        </li>
                                        <li class="govuk-summary-card__action" style="display: inline-block;">
                                            <a class="govuk-link govuk-link--no-visited-state preview-link"
                                                data-preview="preview-{{ page.pageId }}" href="#">
                                                Preview<span class="govuk-visually-hidden"> page {{
                                                    page.pageId }}</span>
                                            </a>
                                            <a class="govuk-link close-link" data-preview="preview-{{ page.pageId }}"
                                                id="close-before-content-{{ page.pageId }}" style="display: none;"
                                                href="#">
                                                Close Preview<span class="govuk-visually-hidden"> page
                                                    {{ page.pageId
                                                    }}</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                {% if not (page.questions and page.questions.length == 1) or
                                (page.conditions and
                                page.conditions.length > 0) or page.pageType == 'guidance' or
                                page.pageHeading %}
                                <div class="govuk-summary-card__content">
                                    <dl class="govuk-summary-list">
                                        {% if page.questions %}
                                        {% for question in page.questions %}
                                        <div class="govuk-summary-list__row">
                                            <dt class="govuk-summary-list__key">Question {{ loop.index
                                                }}</dt>
                                            <dd class="govuk-summary-list__value">{{ question.label }}
                                            </dd>
                                        </div>
                                        {% endfor %}
                                        {% endif %}

                                        {% if page.pageType == 'guidance' %}
                                        <div class="govuk-summary-list__row">
                                            <dt class="govuk-summary-list__key" style="white-space: nowrap;">
                                                Guidance</dt>
                                            <dd class="govuk-summary-list__value">
                                                {% if (page.guidanceOnlyGuidanceTextInput or '').length
                                                > 150 %}
                                                {{ (page.guidanceOnlyGuidanceTextInput or
                                                '').substring(0, 150) }}...
                                                {% else %}
                                                {{ page.guidanceOnlyGuidanceTextInput or '' }}
                                                {% endif %}
                                            </dd>
                                        </div>
                                        {% endif %}

                                        {% if page.setName %}
                                        <div class="govuk-summary-list__row">
                                            <dt class="govuk-summary-list__key">People can answer</dt>
                                            <dd class="govuk-summary-list__value">More than once</dd>
                                        </div>
                                        {% endif %}
                                        {% if page.conditions and page.conditions.length > 0 %}
                                        <div class="govuk-summary-list__row">
                                            <dt class="govuk-summary-list__key">Page shown when</dt>
                                            <dd class="govuk-summary-list__value">
                                                <ul class="govuk-list">
                                                    {% for condition in page.conditions %}
                                                    <li
                                                        style="display: flex; align-items: flex-start; margin-bottom: 10px;">
                                                        <svg style="min-width: 24px; margin-right: 10px; margin-top: 3px;"
                                                            width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                            stroke="#00703c" stroke-width="2">
                                                            <path d="M20 6L9 17l-5-5"></path>
                                                        </svg>
                                                        <div>
                                                            <span class="govuk-!-font-weight-bold">{{
                                                                condition.conditionName
                                                                }}</span>
                                                            <div class="govuk-!-margin-left-3 govuk-!-margin-top-1">
                                                                {% for rule in condition.rules %}
                                                                {% if loop.first %}
                                                                '{{ rule.questionText }}' {{ rule.operator |
                                                                replace("-", " ") }} {% if rule.value | isArray %}'{{
                                                                rule.value | join("' or '") }}'{% else %}'{{ rule.value
                                                                }}'{% endif %}
                                                                {% else %}
                                                                <span class="govuk-!-font-weight-bold">{{
                                                                    rule.logicalOperator | default('AND') }}</span>
                                                                '{{ rule.questionText }}' {{ rule.operator |
                                                                replace("-", " ") }} {% if rule.value | isArray %}'{{
                                                                rule.value | join("' or '") }}'{% else %}'{{ rule.value
                                                                }}'{% endif %}
                                                                {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </dd>
                                        </div>
                                        {% endif %}
                                    </dl>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Right Column: Preview Panel -->
                        <div
                            class="govuk-grid-column-one-half-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full-from-mobile">
                            <div class="preview-container govuk-!-margin-top-1" id="preview-{{ page.pageId }}">
                                <div id="dynamic-preview-content-{{ page.pageId }}">
                                    <!-- Preview Header -->
                                    <div id="before-content"
                                        style="background-color: #cce2d8; display: flex; justify-content: space-between; align-items: center; padding: 8px;">
                                        <p class="govuk-body-s" style="margin-bottom: 0; color: #005a30;">
                                            Preview of page {{ loop.index }}
                                        </p>
                                        <a href="#" id="close-before-content-{{ page.pageId }}" class="govuk-link"
                                            style="color: #005a30;" aria-label="Close Previews">
                                            Close<span class="govuk-visually-hidden"> Previews
                                                section</span>
                                        </a>
                                    </div>
                                    <div style="margin-top: 60px;">
                                        {% from "govuk/components/tabs/macro.njk" import govukTabs %}
                                        <div class="govuk-tabs" data-module="govuk-tabs">
                                            <h2 class="govuk-tabs__title">Contents</h2>
                                            <ul class="govuk-tabs__list">
                                                <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
                                                    <a class="govuk-tabs__tab" href="#tab-one-{{ page.pageId }}">Page
                                                        preview</a>
                                                </li>
                                                {% if page.questions and page.questions.length == 1 %}
                                                <li class="govuk-tabs__list-item">
                                                    <a class="govuk-tabs__tab" href="#tab-two-{{ page.pageId }}">Error
                                                        messages</a>
                                                </li>
                                                {% endif %}
                                            </ul>

                                            <!-- Tab One Panel: Preview -->
                                            <div class="govuk-tabs__panel" id="tab-one-{{ page.pageId }}">
                                                <p class="govuk-body-s" style="margin-bottom: 30px;">
                                                    <a href="#" class="govuk-link govuk-link--no-visited-state"
                                                        rel="noreferrer noopener" target="_blank">
                                                        Preview this page in a new tab
                                                    </a>
                                                </p>

                                                <!-- Dynamic Heading and Guidance -->
                                                <div id="heading-container-{{ page.pageId }}">
                                                    {% if page.setName %}
                                                    <span id="dynamic-caption-{{ page.pageId }}"
                                                        class="govuk-caption-xl"
                                                        data-setname="{{ page.setName | capitalize }}">
                                                        {{ page.setName | capitalize }} {{ loop.index }}
                                                    </span>
                                                    {% endif %}

                                                    <!-- Section Name Caption -->
                                                    {% if page.section %}
                                                    <span class="govuk-caption-l">{{ page.section.name
                                                        }}</span>
                                                    {% endif %}

                                                    {% if page.pageType == 'guidance' %}
                                                    <h1 class="govuk-heading-l">{{
                                                        page.guidanceOnlyHeadingInput or '' }}
                                                    </h1>
                                                    <div class="govuk-body guidance-content"
                                                        id="guidance-content-{{ page.pageId }}">
                                                        {{ page.guidanceOnlyGuidanceTextInput or '' }}
                                                    </div>
                                                    {% else %}
                                                    <h1 class="govuk-heading-xl" id="dynamic-heading-{{ page.pageId }}">
                                                        {{ page.pageHeading or '' }}
                                                    </h1>
                                                    {% endif %}
                                                </div>

                                                <!-- Guidance Paragraph -->
                                                {% if page.guidanceTextarea %}
                                                <p class="govuk-body" id="guidance-paragraph-{{ page.pageId }}">
                                                    {{ page.guidanceTextarea }}
                                                </p>
                                                {% endif %}

                                                <!-- Render each question's preview -->
                                                <div id="preview-container-inner-{{ page.pageId }}">
                                                    <div id="preview-items-{{ page.pageId }}">
                                                        {% if page.questions and page.questions.length >
                                                        0 %}
                                                        {% for question in page.questions %}
                                                        <div class="preview-item"
                                                            data-id="question-{{ question.questionId }}">
                                                            {# Set the preview template based on
                                                            question type and
                                                            subtype
                                                            #}
                                                            {% set previewTemplate = '' %}
                                                            {% if question.type == 'phone' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/phone-preview.html'
                                                            %}
                                                            {% elif question.type == 'address' or (question.type == 'location' and question.subType == 'address') %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/address-preview.html'
                                                            %}
                                                            {% elif question.type == 'location' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/coordinates-preview.html'
                                                            %}
                                                            {% elif question.type == 'file' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/fileupload-preview.html'
                                                            %}
                                                            {% elif question.type == 'email' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/email-preview.html'
                                                            %}
                                                            {% elif question.type == 'text' %}
                                                            {% if question.subType == 'short-answer-nf'
                                                            %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/shorttext-preview.html'
                                                            %}
                                                            {% elif question.subType == 'long-answer' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/textarea-preview.html'
                                                            %}
                                                            {% elif question.subType == 'numbers' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/numbers-preview.html'
                                                            %}
                                                            {% else %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/text-preview.html'
                                                            %}
                                                            {% endif %}
                                                            {% elif question.type == 'date' %}
                                                            {% if question.subType == 'day-month-year' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/date-preview.html'
                                                            %}
                                                            {% elif question.subType == 'month-year' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/date-mmyy-preview.html'
                                                            %}
                                                            {% else %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/date-preview.html'
                                                            %}
                                                            {% endif %}
                                                            {% elif question.type == 'list' %}
                                                            {% if question.subType == 'radios' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/radios-preview.html'
                                                            %}
                                                            {% elif question.subType == 'yes-no' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/yesno-preview.html'
                                                            %}
                                                            {% elif question.subType == 'select' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/autocomplete-preview.html'
                                                            %}
                                                            {% else %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/list-preview.html'
                                                            %}
                                                            {% endif %}
                                                            {% elif question.type == 'declaration' %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/declaration-preview.html'
                                                            %}
                                                            {% else %}
                                                            {% set previewTemplate =
                                                            '/titan-mvp-1.2/form-editor/question-type/questions/previews/default-preview.html'
                                                            %}
                                                            {% endif %}
                                                            {% set total_questions = page.questions |
                                                            length %}
                                                            {% set question_count = total_questions %}
                                                            {% set currentPage = { questions:
                                                            page.questions } %}
                                                            {% include previewTemplate %}
                                                        </div>
                                                        {% endfor %}
                                                        {% else %}
                                                        {# <p>No content available to preview.</p> #}
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                {% if page.setName %}
                                                <button class="govuk-button"
                                                    id="add-another-set-button-{{ page.setName }}">
                                                    Add another
                                                    <span style="text-transform: lowercase;">
                                                        {{ page.setName }}
                                                    </span>
                                                </button>
                                                {% endif %}

                                                <a href="#overviewquestions" class="govuk-skip-link"
                                                    style="margin-bottom: 30px!important;"
                                                    data-module="govuk-skip-link">
                                                    Skip to page overview
                                                </a>
                                            </div>

                                            <!-- Tab Two Panel: Error messages -->
                                            {% if page.questions and page.questions.length == 1 %}
                                            <div class="govuk-tabs__panel" id="tab-two-{{ page.pageId }}" hidden>
                                                <p class="govuk-body-s" style="margin-bottom: 30px;">
                                                    <a href="#" class="govuk-link govuk-link--no-visited-state"
                                                        rel="noreferrer noopener" target="_blank">
                                                        Preview error messages in a new tab
                                                    </a>
                                                </p>
                                                <div class="govuk-error-summary" data-module="govuk-error-summary"
                                                    data-disable-auto-focus="true" hidden>
                                                    <h2 class="govuk-error-summary__title">There is a
                                                        problem</h2>
                                                    <ul class="govuk-list govuk-error-summary__list">
                                                        <!-- List your error messages here -->
                                                    </ul>
                                                </div>
                                                <a href="#overviewquestions" class="govuk-skip-link"
                                                    style="margin-bottom: 30px!important;"
                                                    data-module="govuk-skip-link">
                                                    Skip to page overview
                                                </a>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
                {% endfor %}
                {% endif %}

                <!-- End pages section -->
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-full">
                        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                        <h2 class="govuk-heading-m">End pages</h2>
                    </div>
                </div>

                <!-- Payment pages first -->
                {% for page in formPages %}
                {% if page.questions and page.questions.length > 0 or page.pageType == 'guidance' %}
                {% set hasPaymentQuestions = false %}
                {% if page.questions %}
                {% for question in page.questions %}
                {% if question.type === "payment" %}
                {% set hasPaymentQuestions = true %}
                {% endif %}
                {% endfor %}
                {% endif %}
                {% if page.pageHeading and page.pageHeading.toLowerCase().includes("payment") %}
                {% set hasPaymentQuestions = true %}
                {% endif %}
                {% if hasPaymentQuestions %}
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-one-half-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full-from-mobile">
                        <div class="govuk-summary-card govuk-!-margin-bottom-4" style="border-left: 10px solid #b1b4b6; ">
                            <div class="govuk-summary-card__title-wrapper">
                                <h2 class="govuk-summary-card__title" id="card-title-payment">
                                    Payment page
                                </h2>
                                <ul class="govuk-summary-card__actions">
                                    <li class="govuk-summary-card__action">
                                        <a class="govuk-link govuk-link--no-visited-state" href="/titan-mvp-1.2/edit-page/{{ page.pageId }}">
                                            Edit<span class="govuk-visually-hidden"> page {{ page.pageId }}</span>
                                        </a>
                                    </li>
                                    <li class="govuk-summary-card__action">
                                        <a class="govuk-link govuk-link--no-visited-state preview-link"
                                            data-preview="preview-{{ page.pageId }}" href="#">
                                            Preview<span class="govuk-visually-hidden"> page {{ page.pageId }}</span>
                                        </a>
                                        <a class="govuk-link close-link" data-preview="preview-{{ page.pageId }}"
                                            id="close-before-content-{{ page.pageId }}" style="display: none;" href="#">
                                            Close Preview<span class="govuk-visually-hidden"> page {{ page.pageId }}</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Column for Payment Page -->
                    <div class="govuk-grid-column-one-half-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full-from-mobile">
                        <div class="preview-container govuk-!-margin-top-1" id="preview-{{ page.pageId }}">
                            <div id="dynamic-preview-content-{{ page.pageId }}">
                                <!-- Preview Header -->
                                <div id="before-content"
                                    style="background-color: #cce2d8; display: flex; justify-content: space-between; align-items: center; padding: 8px;">
                                    <p class="govuk-body-s" style="margin-bottom: 0; color: #005a30;">
                                        Preview of Payment page
                                    </p>
                                    <a href="#" id="close-before-content-{{ page.pageId }}" class="govuk-link"
                                        style="color: #005a30;" aria-label="Close Previews">
                                        Close<span class="govuk-visually-hidden"> Previews
                                            section</span>
                                    </a>
                                </div>
                                <div style="margin-top: 60px;">
                                    <!-- Payment Preview Content -->
                                    <div class="payment-summary-wrap">
                                        <div class="payment-summary">
                                            <h1 class="govuk-heading-l" id="preview-question-label">Payment required</h1>
                                            <p id="preview-payment-description" class="govuk-body">{{ page.questions[0].paymentDescription or 'Payment description' }}</p>
                                            {{ govukWarningText({ text: "You must pay before you can send your form", classes: "govuk-!-margin-bottom-4", iconFallbackText: "Warning" }) }}
                                            <p class="govuk-body">When your payment is complete, you'll able to continue with your form.</p>
                                            <p class="govuk-body govuk-!-font-weight-bold">Total amount: <span id="preview-payment-amount" class="amount govuk-!-font-size-36 govuk-!-font-weight-bold">{{ page.questions[0].paymentAmount or '0.00' }}</span></p>
                                            {{ govukButton({ text: "Pay now", classes: "govuk-button--primary govuk-!-margin-top-4 govuk-!-margin-bottom-0" }) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
                {% endfor %}

                <!-- Check Answers page -->
                <div class="govuk-grid-row">
                    <div
                        class="govuk-grid-column-one-half-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full-from-mobile">
                        <!-- Section Break and Heading -->
                        <!-- Main Content: Summary Card -->
                        <div class="govuk-summary-card" style="border-left: 10px solid #b1b4b6;">
                            <div class="govuk-summary-card__title-wrapper">
                                <h2 class="govuk-summary-card__title" id="card-title-check-1q">
                                    Check answers page <span id="page-13-heading-text"></span>
                                </h2>
                                <ul class="govuk-summary-card__actions">
                                    <li class="govuk-summary-card__action">
                                        <a class="govuk-link govuk-link--no-visited-state" id="editpage13"
                                            href="/titan-mvp-1.2/form-editor/check-answers/settings.html">
                                            Edit <span class="govuk-visually-hidden">page 13</span>
                                        </a>
                                    </li>
                                    <li class="govuk-summary-card__action">
                                        <a class="govuk-link govuk-link--no-visited-state preview-link"
                                            data-preview="check-preview" href="#">
                                            Preview <span class="govuk-visually-hidden">page 13</span>
                                        </a>
                                        <a class="govuk-link close-link" data-preview="check-preview"
                                            style="display: none;" href="#">
                                            Close Preview <span class="govuk-visually-hidden">page
                                                13</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            {% if data['checkAnswersGuidanceTextInput'] %}
                            <div class="govuk-summary-card__content">
                                <dl class="govuk-summary-list">
                                    {% if data['declarationOption'] == "yes-declaration" %}
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">Declaration</dt>
                                        <dd class="govuk-summary-list__value">
                                            {% if (data['checkAnswersGuidanceTextInput'] or '').length >
                                            150 %}
                                            {{ (data['checkAnswersGuidanceTextInput'] or
                                            '').substring(0, 150) }}...
                                            {% else %}
                                            {{ data['checkAnswersGuidanceTextInput'] or '' }}
                                            {% endif %}
                                        </dd>
                                    </div>
                                    {% endif %}
                                </dl>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Preview Column -->
                    <div
                        class="govuk-grid-column-one-half-from-desktop govuk-grid-column-full-from-tablet govuk-grid-column-full-from-mobile">
                        <!-- Preview Container -->
                        <div class="preview-container govuk-!-margin-top-1"
                            style="outline-color: #b1b4b6; box-shadow: 5px 10px #b1b4b6;" id="check-preview">
                            <div id="dynamic-preview-content-check">
                                <!-- Preview Header -->
                                <div id="before-content"
                                    style="background-color: #e3e3e3; outline-color: #b1b4b6; border-bottom-color: #b1b4b6; display: flex; justify-content: space-between; align-items: left;">
                                    <p class="govuk-body-s"
                                        style="margin-bottom: 0; color: #0b0c0c; padding: 2px 8px 2px;">
                                        Preview of Check answers page
                                    </p>
                                    <a href="#" id="close-before-content" class="govuk-link" style="color: #0b0c0c;"
                                        aria-label="Close Previews">
                                        Close<span class="govuk-visually-hidden"> Previews
                                            section</span>
                                    </a>
                                </div>

                                <div style="margin-top: 60px;">
                                    <!-- Tab Structure -->
                                    <div class="govuk-tabs" data-module="govuk-tabs">
                                        <h2 class="govuk-tabs__title">Contents</h2>
                                        <ul class="govuk-tabs__list">
                                            <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
                                                <a class="govuk-tabs__tab" href="#tab-one">Page
                                                    preview</a>
                                            </li>
                                        </ul>

                                        <!-- Tab One Content -->
                                        <div class="govuk-tabs__panel" id="tab-one">
                                            <p class="govuk-body-s" style="margin-bottom: 30px;">
                                                <a href="#" class="govuk-link govuk-link--no-visited-state"
                                                    rel="noreferrer noopener" target="_blank">
                                                    Preview this page in a new tab
                                                </a>
                                            </p>

                                            <!-- Dynamic Heading -->
                                            <div id="heading-container">
                                                {% if data['setName'] %}
                                                <span id="dynamic-caption" class="govuk-caption-xl"
                                                    data-setname="{{ data['setName'] | capitalize }}">
                                                    {{ data['setName'] | capitalize }} 1
                                                </span>
                                                {% endif %}
                                                <h1 class="govuk-heading-l" id="dynamic-heading">
                                                    Check your answers before sending your form
                                                </h1>
                                            </div>

                                            <!-- Summary List -->
                                            <dl class="govuk-summary-list govuk-!-margin-bottom-9">
                                                <!-- Business registered with RPA -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Business
                                                        registered with RPA
                                                    </dt>
                                                    <dd class="govuk-summary-list__value">Yes</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                registration
                                                                status</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Country for livestock -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Country for
                                                        livestock</dt>
                                                    <dd class="govuk-summary-list__value">England</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                country</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Arrival date of livestock -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Arrival date of
                                                        livestock</dt>
                                                    <dd class="govuk-summary-list__value">20 04 2024
                                                    </dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                arrival
                                                                date</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Type of livestock -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Type of
                                                        livestock</dt>
                                                    <dd class="govuk-summary-list__value">Cow</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                livestock
                                                                type</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Applicant's name -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Applicant's name
                                                    </dt>
                                                    <dd class="govuk-summary-list__value">John Doe</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                applicant
                                                                name</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Business name -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Business name
                                                    </dt>
                                                    <dd class="govuk-summary-list__value">Doe Farms Ltd
                                                    </dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                business
                                                                name</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Main phone number -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Main phone
                                                        number</dt>
                                                    <dd class="govuk-summary-list__value">07700 900457
                                                    </dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                phone
                                                                number</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Email address -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Email address
                                                    </dt>
                                                    <dd class="govuk-summary-list__value">
                                                        john.doe@example.com</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                email
                                                                address</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Business address -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Business address
                                                    </dt>
                                                    <dd class="govuk-summary-list__value">123 Farm Lane,
                                                        Rural Town</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                business
                                                                address</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Business purpose -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Business purpose
                                                    </dt>
                                                    <dd class="govuk-summary-list__value">Livestock
                                                        farming</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                business
                                                                purpose</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- National Grid field number -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">National Grid
                                                        field number</dt>
                                                    <dd class="govuk-summary-list__value">NG123456</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                field
                                                                number</span>
                                                        </a>
                                                    </dd>
                                                </div>

                                                <!-- Methodology statement -->
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key">Methodology
                                                        statement</dt>
                                                    <dd class="govuk-summary-list__value">1 file
                                                        uploaded</dd>
                                                    <dd class="govuk-summary-list__actions">
                                                        <a class="govuk-link govuk-link--no-visited-state" href="#"
                                                            style="color: #b1b4b6; cursor: default;"
                                                            onclick="event.preventDefault(); event.stopPropagation(); this.blur(); return false;">
                                                            Change<span class="govuk-visually-hidden">
                                                                methodology
                                                                statement</span>
                                                        </a>
                                                    </dd>
                                                </div>
                                            </dl>

                                            <!-- Guidance Paragraph -->
                                            <p class="govuk-body" id="guidance-paragraph">
                                                {{ data['checkAnswersGuidanceTextInput'] or '' }}
                                            </p>

                                            <!-- Conditional Button -->
                                            {% if data['checkAnswersGuidanceTextInput'] %}
                                            {{ govukButton({
                                            text: "Accept and send",
                                            classes: "govuk-button govuk-!-margin-top-3",
                                            id: "accept-and-send-button",
                                            disabled: true
                                            }) }}
                                            {% else %}
                                            {{ govukButton({
                                            text: "Send",
                                            classes: "govuk-button govuk-!-margin-top-3",
                                            id: "send-button",
                                            disabled: true
                                            }) }}
                                            {% endif %}

                                            <a href="#editpage13" class="govuk-skip-link"
                                                style="margin-bottom: 30px!important;" data-module="govuk-skip-link">
                                                Close preview and skip to page 13 details
                                            </a>
                                        </div> <!-- End of Tab One -->
                                    </div> <!-- End of govuk-tabs -->
                                </div>
                            </div> <!-- End of dynamic-preview-content-check -->
                        </div> <!-- End of preview-container -->
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const dynamicCaption = document.getElementById("dynamic-caption");
                const setName = dynamicCaption ? dynamicCaption.getAttribute("data-setname") : null;

                if (!setName && dynamicCaption) {
                    dynamicCaption.style.display = "none";
                }
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Add event listener to all preview links
                document.querySelectorAll(".preview-link").forEach(link => {
                    link.addEventListener("click", function (e) {
                        e.preventDefault();
                        // Get the ID of the preview container to open
                        const previewId = this.dataset.preview;
                        const previewContainer = document.getElementById(previewId);

                        if (previewContainer) {
                            // Show the preview container
                            previewContainer.style.display = "block";

                            // Move focus to the "Close Previews" link;
                            // use an attribute selector so it works with our unique IDs.
                            const closeLink = previewContainer.querySelector("[id^='close-before-content']");
                            if (closeLink) {
                                closeLink.focus();
                            }
                        }
                    });
                });

                // Add event listener to all close links within previews using an attribute selector
                document.querySelectorAll("[id^='close-before-content']").forEach(link => {
                    link.addEventListener("click", function (e) {
                        e.preventDefault();
                        // Get the parent preview container
                        const previewContainer = this.closest(".preview-container");

                        if (previewContainer) {
                            // Hide the preview container
                            previewContainer.style.display = "none";

                            // Move focus back to the corresponding preview link
                            const previewLink = document.querySelector(`.preview-link[data-preview="${previewContainer.id}"]`);
                            if (previewLink) {
                                previewLink.focus();
                            }
                        }
                    });
                });

                // Add event listener to all "Close preview and skip" links
                document.querySelectorAll("[data-module='govuk-skip-link']").forEach(link => {
                    link.addEventListener("click", function (e) {
                        e.preventDefault();

                        // Get the ID to skip to from the href attribute
                        const targetId = this.getAttribute("href").substring(1);
                        const targetElement = document.getElementById(targetId);

                        // Hide the current preview if applicable
                        const previewContainer = this.closest(".preview-container");
                        if (previewContainer) {
                            previewContainer.style.display = "none";
                        }

                        // Move focus to the target section if it exists
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: "smooth" });
                            targetElement.focus();
                        }
                    });
                });
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const dynamicCaption = document.getElementById("dynamic-caption");
                const setName = dynamicCaption ? dynamicCaption.getAttribute("data-setname") : null;

                if (!setName && dynamicCaption) {
                    dynamicCaption.style.display = "none";
                }
            });
        </script>

        {% endblock %}

        {% block pageScripts %}
        <script>
            // Single script to handle preview functionality
            (function () {
                // Get the preview link
                const previewLink = document.getElementById('preview-link');

                if (!previewLink) {
                    console.error('Preview link not found');
                    return;
                }

                // Show preview link if we have pages
                const pageCards = document.querySelectorAll('.app-page-card');
                const paymentCards = document.querySelectorAll('[id^="card-title-payment"]').length > 0;
                if (pageCards.length > 0 || paymentCards) {
                    previewLink.style.display = 'inline-block';
                    document.getElementById('reorder-button').style.display = 'inline-block';
                }

                // Handle preview link click
                previewLink.onclick = function (e) {
                    e.preventDefault();

                    // Collect data from all pages
                    const formPages = [];

                    // Process regular page cards
                    pageCards.forEach((card, index) => {
                        console.log(`Processing card ${index + 1}:`, card);

                        // Get the summary card title
                        const titleElement = card.querySelector('.govuk-summary-card__title');
                        const title = titleElement ? titleElement.textContent.trim().replace(/^Page \d+:\s*/, '') : '';

                        // Determine if it's a guidance page by checking for the guidance class or data attribute
                        const isGuidance = card.querySelector('.govuk-summary-card').style.borderLeft.includes('b1b4b6') ||
                            card.querySelector('.guidance-card');

                        // Get page ID from the edit link
                        const editLink = card.querySelector('a[href*="/titan-mvp-1.2/edit-page/"], a[href*="/edit-guidance"]');
                        if (!editLink) {
                            console.warn(`No edit link found for card ${index + 1}`);
                            return;
                        }

                        // Extract page ID from the edit link
                        let pageId;
                        if (isGuidance) {
                            pageId = new URLSearchParams(editLink.href.split('?')[1]).get('pageId');
                        } else {
                            pageId = editLink.href.split('/titan-mvp-1.2/edit-page/')[1];
                        }

                        // Get questions data
                        const questions = [];
                        if (!isGuidance) {
                            const questionRows = card.querySelectorAll('.govuk-summary-list__row');
                            questionRows.forEach(row => {
                                const key = row.querySelector('.govuk-summary-list__key')?.textContent.trim();
                                const value = row.querySelector('.govuk-summary-list__value')?.textContent.trim();

                                // Only add if it's a question (not metadata like conditions)
                                if (key && !key.includes('Page shown when')) {
                                    questions.push({
                                        questionId: Date.now() + Math.random(),
                                        label: key.startsWith('Question') ? value : key,
                                        hint: '',
                                        type: 'text',
                                        subType: 'short-answer-nf',
                                        options: []
                                    });
                                }
                            });
                        }

                        // Get guidance content
                        let guidanceContent = '';
                        if (isGuidance) {
                            const guidanceRow = card.querySelector('.govuk-summary-list__row');
                            if (guidanceRow) {
                                guidanceContent = guidanceRow.querySelector('.govuk-summary-list__value')?.textContent.trim() || '';
                            }
                        }

                        // Create the page object
                        const pageData = {
                            pageId: pageId || Date.now() + Math.random(),
                            pageType: isGuidance ? 'guidance' : 'question',
                            title: title,
                            pageHeading: title,
                            guidanceTextarea: guidanceContent,
                            guidanceOnlyHeadingInput: isGuidance ? title : '',
                            guidanceOnlyGuidanceTextInput: guidanceContent,
                            questions: questions,
                            order: index + 1
                        };

                        console.log('Adding page:', pageData);
                        formPages.push(pageData);
                    });

                    // Process payment pages
                    const paymentPageCards = document.querySelectorAll('[id^="card-title-payment"]');
                    paymentPageCards.forEach((card, index) => {
                        console.log(`Processing payment card ${index + 1}:`, card);

                        // Get the page ID from the edit link
                        const editLink = card.closest('.govuk-summary-card').querySelector('a[href*="/titan-mvp-1.2/edit-page/"]');
                        if (!editLink) {
                            console.warn(`No edit link found for payment card ${index + 1}`);
                            return;
                        }

                        const pageId = editLink.href.split('/titan-mvp-1.2/edit-page/')[1];

                        // Create payment page object
                        const paymentPageData = {
                            pageId: pageId || Date.now() + Math.random(),
                            pageType: 'payment',
                            title: 'Payment page',
                            pageHeading: 'Payment page',
                            guidanceTextarea: '',
                            guidanceOnlyHeadingInput: '',
                            guidanceOnlyGuidanceTextInput: '',
                            questions: [{
                                questionId: Date.now() + Math.random(),
                                label: 'Payment',
                                hint: '',
                                type: 'payment',
                                subType: 'payment',
                                paymentAmount: '0.00',
                                paymentDescription: 'Payment description',
                                errorMessage: 'payment',
                                testApiKey: '',
                                liveApiKey: '',
                                options: []
                            }],
                            order: formPages.length + index + 1
                        };

                        console.log('Adding payment page:', paymentPageData);
                        formPages.push(paymentPageData);
                    });

                    console.log('Preview data:', formPages);

                    if (formPages.length === 0) {
                        console.error('No valid pages found to preview');
                        alert('No pages found to preview. Please add some pages first.');
                        return;
                    }

                    // Store data and navigate
                    sessionStorage.setItem('formPages', JSON.stringify(formPages));
                    window.location.href = '/titan-mvp-1.2/form-editor/preview';
                };

                // Handle reorder button click
                const reorderButton = document.getElementById('reorder-button');
                if (reorderButton) {
                    reorderButton.onclick = function (e) {
                        e.preventDefault();
                        window.location.href = '/titan-mvp-1.2/form-editor/reorder/main.html';
                    };
                }
            })();
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const applyFiltersButton = document.getElementById('apply-filters');
                const selectedFilters = document.getElementById('selected-filters');
                const filterSummary = document.getElementById('filter-summary');
                const pageCards = document.querySelectorAll('.app-page-card');

                // Handle edit option clicks
                document.addEventListener('click', function (e) {
                    if (e.target.closest('.govuk-link') && e.target.closest('.govuk-link').href.includes('editoption.html')) {
                        e.preventDefault();
                        const listItem = e.target.closest('.gem-c-reorderable-list__item');
                        const index = listItem.dataset.index;
                        const label = listItem.querySelector('.option-label-display').textContent.trim();
                        const hint = listItem.querySelector('.option-hint-input').value;

                        // Show the add option form
                        const addOptionForm = document.getElementById('add-option-form');
                        const addOptionButton = document.getElementById('add-option-button');
                        const newOptionLabel = document.getElementById('new-option-label');
                        const newOptionHint = document.getElementById('new-option-hint');
                        const saveItemButton = document.getElementById('save-new-option');

                        addOptionForm.style.display = 'block';
                        addOptionButton.style.display = 'none';

                        // Populate the form with existing values
                        newOptionLabel.value = label;
                        newOptionHint.value = hint;

                        // Update the heading
                        document.getElementById('add-option-heading').textContent = `Edit item ${index}`;

                        // Store the index being edited
                        addOptionForm.dataset.editIndex = index;

                        // Change save button text
                        saveItemButton.textContent = 'Save changes';

                        // Focus on the label input
                        newOptionLabel.focus();

                        // Update preview to highlight the edited item
                        updatePreview();
                        applyHighlight('label');
                    }
                });

                // Update save functionality to handle both new and edit cases
                document.getElementById('save-new-option').addEventListener('click', function (e) {
                    e.preventDefault();
                    const addOptionForm = document.getElementById('add-option-form');
                    const editIndex = addOptionForm.dataset.editIndex;
                    const labelValue = document.getElementById('new-option-label').value.trim();
                    const hintValue = document.getElementById('new-option-hint').value.trim();

                    if (editIndex) {
                        // Edit existing item
                        const listItem = document.querySelector(`.gem-c-reorderable-list__item[data-index="${editIndex}"]`);
                        if (listItem) {
                            listItem.querySelector('.option-label-display').textContent = labelValue;
                            listItem.querySelector('.option-label-input-hidden').value = labelValue;
                            listItem.querySelector('.option-hint-input').value = hintValue;
                        }
                        // Reset edit mode
                        addOptionForm.dataset.editIndex = '';
                        document.getElementById('save-new-option').textContent = 'Save item';
                    } else {
                        // Add new item (existing code)
                        const currentOptions = optionsContainer.querySelectorAll('.gem-c-reorderable-list__item');
                        const newIndex = currentOptions.length;

                        const newOptionHTML = `
                <li class="gem-c-reorderable-list__item" draggable="true" data-index="${newIndex + 1}">
                    <div class="gem-c-reorderable-list__wrapper">
                        <div class="gem-c-reorderable-list__content">
                            <p class="govuk-body fauxlabel option-label-display" id="option-${newIndex + 1}-label-display">
                                ${labelValue}
                            </p>
                            <input type="hidden" id="option-${newIndex + 1}-label" class="option-label-input-hidden" 
                                name="option[${newIndex + 1}][option_label]" value="${labelValue}">
                            <input type="hidden" id="option-${newIndex + 1}-hint" class="option-hint-input"
                                name="option[${newIndex + 1}][option_hint]" value="${hintValue}">
                        </div>
                        <div class="gem-c-reorderable-list__actions">
                            <button class="gem-c-button govuk-button govuk-button--secondary js-reorderable-list-up"
                                type="button" aria-label="Move option up">Up</button>
                            <button class="gem-c-button govuk-button govuk-button--secondary js-reorderable-list-down"
                                type="button" aria-label="Move option down">Down</button>
                        </div>
                        <div class="edit-item">
                            <ul class="govuk-summary-list__actions-list">
                                <li class="govuk-summary-list__actions-list-item">
                                    <a class="govuk-link govuk-link--no-visited-state" href="editoption.html?index=${newIndex + 1}">
                                        Edit<span class="govuk-visually-hidden">option ${newIndex + 1}</span>
                                    </a>
                                </li>
                                <li class="govuk-summary-list__actions-list-item">
                                    <a class="govuk-link govuk-link--destructive delete-option-link" href="delete-option.html?index=${newIndex + 1}&text=${encodeURIComponent(labelValue)}" onclick="return true;">
                                        Delete<span class="govuk-visually-hidden"> list item</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
            `;
                        optionsContainer.insertAdjacentHTML('beforeend', newOptionHTML);
                    }

                    hideForm();
                    updateAllOptionsPreview();
                    updateHiddenOptionsData();
                    updateEditButtonVisibility();
                    updateMoveButtons();
                });
            });
        </script>

        <script>
            document.getElementById('form-upload').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Here you can handle the file upload
                    console.log('File selected:', file.name);
                    // You can add your file upload logic here
                }
            });

            document.getElementById('form-download').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Here you can handle the file download
                    console.log('File selected for download:', file.name);
                    // You can add your file download logic here
                }
            });
        </script>

        <script>
            function downloadForm() {
                // Get all page cards
                const pageCards = document.querySelectorAll('.app-page-card');
                const formPages = [];

                // Collect data from all pages
                pageCards.forEach((card, index) => {
                    // Get the summary card title
                    const titleElement = card.querySelector('.govuk-summary-card__title');
                    const title = titleElement ? titleElement.textContent.trim().replace(/^Page \d+:\s*/, '') : '';

                    // Determine if it's a guidance page
                    const isGuidance = card.querySelector('.govuk-summary-card').style.borderLeft.includes('b1b4b6') ||
                        card.querySelector('.guidance-card');

                    // Get page ID from the edit link
                    const editLink = card.querySelector('a[href*="/titan-mvp-1.2/edit-page/"], a[href*="/edit-guidance"]');
                    if (!editLink) {
                        console.warn(`No edit link found for card ${index + 1}`);
                        return;
                    }

                    // Extract page ID from the edit link
                    let pageId;
                    if (isGuidance) {
                        pageId = new URLSearchParams(editLink.href.split('?')[1]).get('pageId');
                    } else {
                        pageId = editLink.href.split('/titan-mvp-1.2/edit-page/')[1];
                    }

                    // Get questions data
                    const questions = [];
                    if (!isGuidance) {
                        const questionRows = card.querySelectorAll('.govuk-summary-list__row');
                        questionRows.forEach(row => {
                            const key = row.querySelector('.govuk-summary-list__key')?.textContent.trim();
                            const value = row.querySelector('.govuk-summary-list__value')?.textContent.trim();

                            // Only add if it's a question (not metadata like conditions)
                            if (key && !key.includes('Page shown when')) {
                                questions.push({
                                    questionId: Date.now() + Math.random(),
                                    label: key.startsWith('Question') ? value : key,
                                    hint: '',
                                    type: 'text',
                                    subType: 'short-answer-nf',
                                    options: []
                                });
                            }
                        });
                    }

                    // Get guidance content
                    let guidanceContent = '';
                    if (isGuidance) {
                        const guidanceRow = card.querySelector('.govuk-summary-list__row');
                        if (guidanceRow) {
                            guidanceContent = guidanceRow.querySelector('.govuk-summary-list__value')?.textContent.trim() || '';
                        }
                    }

                    // Create the page object
                    const pageData = {
                        pageId: pageId || Date.now() + Math.random(),
                        pageType: isGuidance ? 'guidance' : 'question',
                        title: title,
                        pageHeading: title,
                        guidanceTextarea: guidanceContent,
                        guidanceOnlyHeadingInput: isGuidance ? title : '',
                        guidanceOnlyGuidanceTextInput: guidanceContent,
                        questions: questions,
                        order: index + 1
                    };

                    formPages.push(pageData);
                });

                if (formPages.length === 0) {
                    alert('No pages found to download. Please add some pages first.');
                    return;
                }

                // Create the complete form data object
                const formData = {
                    name: "Form Export",
                    version: "1.0",
                    lastExported: new Date().toISOString(),
                    pages: formPages
                };

                // Convert the data to a string
                const dataStr = JSON.stringify(formData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                // Create a link element
                const exportFileDefaultName = 'form-export.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
        </script>
        {% endblock %}