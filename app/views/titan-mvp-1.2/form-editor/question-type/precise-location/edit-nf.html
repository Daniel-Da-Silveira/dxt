{% extends "layouts/main.html" %}
{% from "components/service-header/macro.njk" import serviceHeader %}
{% set pageName %}Edit page {{ pageNumber }}: question {{ questionNumber }} - {{ form.name }}{% endset %}
{% set headingPlaceholder = "Page heading" %}
{% set guidancePlaceholder = "" %}

{% block header %}
{{ serviceHeader({
organisationName: "Defra",
productName: "Form Designer",
serviceName: "",
containerClasses: containerClasses,
accountName: "Chris Smith",
homepageLink: "/",
signOutLink: "/onboarding/sign-out-confirmation",
navigationItems: [
{ href: "/titan-mvp-1.2/library.html", text: "Forms library", id: "nav-library" },
{ href: "/cph-overview/draft/complete-clean.html", text: "Overview", id: "nav-overview" },
{ href: "/titan-mvp-1.2/form-editor/listing", text: "Editor", id: "nav-editor" } ],
activeLinkId: "nav-editor"
}) }}

<div class="x-govuk-masthead x-govuk-masthead--large">
    <div class="govuk-width-container">

        {{ govukBackLink({ classes: "govuk-back-link--inverse govuk-!-margin-bottom-0", text:
        commonTerms.form_editor.information_type.back, href: "/titan-mvp-1.2/form-editor/listing.html" }) }}

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible"
            style="border-bottom: 1px solid white; margin-bottom: 0" />

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full-from-desktop">
                <h1 class="x-govuk-masthead__title">
                    {{ form.name }}
                </h1>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <div class="govuk-grid-row">
            <!-- Left Column for Form Controls -->
            <div class="govuk-grid-column-one-half-from-desktop" id="container" style="flex: 1 1 75%; overflow-y: auto">
                <div class="govuk-summary-card govuk-!-margin-top-0" style="border-left: 10px solid #008938">
                    <div class="govuk-summary-card__content govuk-!-padding-top-0" style="background-color: #f3f2f1">
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dd class="govuk-summary-list__value">
                                    <!-- Dynamic Summary List -->
                                    <!-- Question Settings Container -->
                                    <div class="govuk-grid-row" id="page-settings-container-1">
                                        <div id="question-1">
                                            <div class="govuk-summary-card__content" style="margin-bottom: 0">
                                                <!-- Sub Navigation for Question -->
                                                <nav class="moj-sub-navigation govuk-!-padding-top-0 govuk-!-margin-bottom-2 "
                                                    aria-label="Sub navigation">
                                                    <ul class="moj-sub-navigation__list" id="nav-list2">
                                                        <li class="moj-sub-navigation__item">
                                                            <a class="moj-sub-navigation__link" aria-current="page"
                                                                href="#question-1-information-type">Question {{
                                                                questionNumber }}</a>
                                                        </li>
                                                    </ul>
                                                </nav>

                                                <div class="govuk-summary-card__title-wrapper govuk-!-padding-top-0">
                                                </div>

                                                <span class="govuk-caption-l">Page {{ pageNumber }}</span>
                                                <h2 class="govuk-heading-l">Edit question {{ questionNumber }}</h2>

                                                <form id="s" action="/titan-mvp-1.2/question-configuration-save"
                                                    method="post">
                                                    <!-- Hidden input to pass the location format -->
                                                    <input type="hidden" name="locationFormat" value="{{ data.locationSubType }}">

                                                    {% from "govuk/components/input/macro.njk" import govukInput %}
                                                    {% from "govuk/components/radios/macro.njk" import govukRadios %}
                                                    {% from "govuk/components/textarea/macro.njk" import govukTextarea
                                                    %}
                                                    {% from "components/location/macro.njk" import eastingNorthing,
                                                    gridReference, osGridReferenceNumber, longitudeLatitude,
                                                    nationalGridFieldNumber %}




                                                    <!-- Location Format Display (Read-only) -->
                                                    {# <div class="govuk-form-group">
                                                        <fieldset class="govuk-fieldset">
                                                            <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                                                                Location format
                                                            </legend>
                                                            <div class="govuk-radios govuk-radios--small" data-module="govuk-radios">
                                                                <div class="govuk-radios__item">
                                                                    <input class="govuk-radios__input" id="location-format-display" name="locationFormatDisplay" type="radio" value="{{ data.locationSubType }}" checked disabled>
                                                                    <label class="govuk-label govuk-radios__label" for="location-format-display">
                                                                        {% if data.locationSubType === "easting_northing" %}
                                                                            Easting and northing
                                                                        {% elif data.locationSubType === "os_grid_number" %}
                                                                            Ordnance Survey (OS) grid reference
                                                                        {% elif data.locationSubType === "field_number" %}
                                                                            National Grid field number
                                                                        {% elif data.locationSubType === "longitude_latitude" %}
                                                                            Latitude and longitude
                                                                        {% else %}
                                                                            Location format
                                                                        {% endif %}
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </fieldset>
                                                    </div> #}

                                                    <!-- Question Label Input -->
                                                    <div class="govuk-form-group">
                                                        <label class="govuk-label govuk-label--m"
                                                            for="question-label-input-precise-location">
                                                            {{ commonTerms.form_editor.question_settings.question }}
                                                        </label>
                                                        <input class="govuk-input"
                                                            id="question-label-input-precise-location"
                                                            name="questionLabelInputPreciseLocation" type="text"
                                                            value="">
                                                    </div>

                                                    <!-- Hint Text -->
                                                    {{ govukTextarea({
                                                    id: "hint-text-input-precise-location",
                                                    name: "hintTextInputPreciseLocation",
                                                    label: {
                                                    text: "Hint text (optional)",
                                                    classes: "govuk-label--m",
                                                    isPageHeading: false
                                                    },
                                                    hint: {
                                                    text: "This location format includes default hint text. Only change
                                                    the hint text if the default text does not meet your needs."
                                                    },
                                                    rows: 3
                                                    }) }}

                                                    {#
                                            </div> #}

                                            {{ govukInput({
                                            label: {
                                            text:
                                            commonTerms.form_editor.question_settings.short_description.title,
                                            classes: "govuk-label--m",
                                            isPageHeading: false
                                            },
                                            hint: {
                                            text:
                                            commonTerms.form_editor.question_settings.short_description.hint
                                            },
                                            id: "error-message-input-precise-location",
                                            name: "errorMessageInputPreciseLocation"
                                            }) }}

                                            <!-- Additional Settings -->
                                            {% set helpTextHtml %}
                                            {% set helpTextDefault -%}
{% if data.locationSubType === 'field_number' %}
Use the [MAGIC map tool](https://magic.defra.gov.uk/) to find the National Grid field number for your land or buildings. Follow these instructions:

  1. Select ‘Get Started’.
  2. Search for a postcode or place.
  3. Using the map, locate the land or building. Use the +/- icons to zoom in and out.
  4. In the top toolbar, select the fourth icon along ('Where am I?') - it looks like a target.
  5. Click on the land or building.
  6. A pop-up box will appear showing the land details for this location. The National Grid field number is the third number from the top of the list. It is made up of 2 letters and 8 numbers, for example, SO04188589.
{% elif data.locationSubType === 'easting_northing' %}
Use the [MAGIC map tool](https://magic.defra.gov.uk/) to find the Easting and Northing for your land or buildings. Follow these instructions:

  1. Select ‘Get Started’.
  2. Search for a postcode or place.
  3. Using the map, locate the land or building. Use the +/- icons to zoom in and out.
  4. In the top toolbar, select the fourth icon along ('Where am I?') - it looks like a target.
  5. Click on the land or building.
  6. A pop-up box will appear showing the land details for this location. Easting and Northing appear at the top of the list. They are made up of 6 digits each, for example, 248741 and 63688.
{% elif data.locationSubType === 'os_grid_number' %}
Use the [Ordnance Survey](https://explore.osmaps.com/). Follow these instructions:

1. Search for a county, place or postcode.
2. Using the map, locate the field or building. Use the +/- icons to zoom in and out.
3. Right click on each individual building or field to find the OS grid reference.
{% elif data.locationSubType === 'longitude_latitude' %}
Use the [MAGIC map tool](https://magic.defra.gov.uk/) to find the latitude and longitude for your land or buildings. Follow these instructions:

  1. Select ‘Get Started’.
  2. Search for a postcode or place.
  3. Using the map, locate the land or building. Use the +/- icons to zoom in and out.
  4. In the top toolbar, select the fourth icon along ('Where am I?') - it looks like a target.
  5. Click on the land or building.
  6. A pop-up box will appear showing the land details for this location. The latitude and longitude are four numbers down from the top of the list.
{% else %}
Provide instructions to help users answer this question.
{% endif %}
{%- endset %}

                                            {{ govukTextarea({
                                            id: "help-text-input-precise-location",
                                            name: "helpTextInputPreciseLocation",
                                            label: {
                                            text: "Instructions to help users answer this question",
                                            classes: "govuk-label--s"
                                            },
                                            hint: {
                                            text: "You can use markdown formatting."
                                            },
                                            rows: 12,
                                            value: helpTextDefault | trim
                                            }) }}
                                            {% endset -%}

                                            {{ govukCheckboxes({
                                            name: "additionalSettings",
                                            classes: "govuk-checkboxes--small",
                                            fieldset: {
                                            legend: {
                                            text: "Additional settings (optional)",
                                            isPageHeading: false,
                                            classes: "govuk-fieldset__legend--m"
                                            }
                                            },
                                            hint: {
                                            text: "You should choose a location format first before adding additional
                                            settings."
                                            },
                                            items: [
                                            {
                                            value: "make-optional",
                                            text: commonTerms.form_editor.question_settings.optional
                                            },
                                            {
                                            value: "add-help-text",
                                            text: "Give instructions to help users answer this question",
                                            conditional: {
                                            html: helpTextHtml
                                            }
                                            }
                                            ]
                                            }) }}

                                            <!-- Section Break -->
                                            <hr
                                                class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

                                            <!-- Question Settings Summary List -->
                                            <h2 class="govuk-heading-m">{{
                                                commonTerms.form_editor.question_settings.title }}</h2>

                                            {% set locationFormatText %}
                                                {% if data.locationSubType === 'easting_northing' %}
                                                    Easting and northing
                                                {% elif data.locationSubType === 'os_grid_number' %}
                                                    Ordnance Survey (OS) grid reference
                                                {% elif data.locationSubType === 'field_number' %}
                                                    National Grid field number
                                                {% elif data.locationSubType === 'longitude_latitude' %}
                                                    Latitude and longitude
                                                {% else %}
                                                    Location format
                                                {% endif %}
                                            {% endset %}

                                            {{ govukSummaryList({
                                            "rows": [
                                            {
                                            "key": {
                                            "text": "Type of information"
                                            },
                                            "value": {
                                            "text": locationFormatText
                                            },
                                            "actions": {
                                            "items": [
                                            {
                                            "href": "/titan-mvp-1.2/form-editor/information-type-nf.html",
                                            "text": commonTerms.form_editor.common.edit,
                                            "visuallyHiddenText": " type"
                                            }
                                            ]
                                            }
                                            }
                                            ]
                                            }) }}

                                            <hr
                                                class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

                                            <!-- Submit Button -->
                                            <div class="moj-button-action">
                                                {{ govukButton({
                                                text: commonTerms.form_editor.common.continue,
                                                type: 'submit'
                                                }) }}
                                            </div>
                                            </form>

                                        </div>
                                    </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column for Preview -->
        <div class="govuk-grid-column-one-half-from-desktop" id="second-container"
            style="outline: solid 1px #008938; height: 100%; position: sticky; top: 0; padding: 20px; box-shadow: 5px 10px #008938;">
            <!-- Before content -->
            <div id="before-content" style=" background-color:  #cce2d8;">
                <p class="govuk-body-s" style="margin-bottom: 0; color: #005a30; padding: 2px 8px 3px;
text-align: center;"> Previews
                </p>
            </div>

            <div style="margin-top: 60px;">
                {% from "govuk/components/tabs/macro.njk" import govukTabs %}

                <div class="govuk-tabs" data-module="govuk-tabs">
                    <h2 class="govuk-tabs__title">
                        Contents
                    </h2>
                    <ul class="govuk-tabs__list">
                        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
                            <a class="govuk-tabs__tab" href="#tab-one">Page preview</a>
                        </li>
                        <li class="govuk-tabs__list-item">
                            <a class="govuk-tabs__tab" href="#tab-two">Error messages</a>
                        </li>
                    </ul>

                    <div class="govuk-tabs__panel" id="tab-one">
                        <!-- Page Preview Content -->

                        <p class="govuk-body-s" style="margin-bottom: 30px; border-bottom: #008938 1px;">
                            <a href="#" class="govuk-link govuk-link--no-visited-state" rel="noreferrer noopener"
                                target="_blank">
                                Preview this page in a new tab
                            </a>
                        </p>

                        <div class="preview-content" id="precise-location-preview">
                            <!-- Preview content will be dynamically updated -->
                            <div class="border-left-container">
                                <div id="coordinate-inputs-preview">
                                    <!-- Dynamic coordinate inputs will be inserted here -->
                                </div>

                                <!-- Empty state message -->
                                <div id="empty-state-message" style="display: none;">
                                    <div class="govuk-form-group">
                                        <fieldset class="govuk-fieldset row-prototype-coordinate-input" role="group">
                                            <legend class="govuk-fieldset__legend govuk-fieldset__legend--l"
                                                id="question-label-legend">
                                                Question
                                            </legend>
                                            <div class="govuk-summary-list govuk-!-margin-top-4">
                                                <div class="govuk-summary-list__row">
                                                    <dt class="govuk-summary-list__key govuk-hint"
                                                        style="font-weight: normal;">No location format selected
                                                    </dt>
                                                    <dd class="govuk-summary-list__actions"></dd>
                                                </div>
                                            </div>
                                        </fieldset>
                                    </div>
                                </div>

                                <!-- Help Component -->
                                <div id="help-component-preview" style="display: none;">
                                    <details class="govuk-details" data-module="govuk-details">
                                        <summary class="govuk-details__summary">
                                            <span class="govuk-details__summary-text">
                                                How to find location details
                                            </span>
                                        </summary>
                                        <div class="govuk-details__text" id="help-content">
                                            <!-- Dynamic help content will be inserted here -->
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>

                        <a href="#edit-page" class="govuk-skip-link" style="margin-bottom: 30px!important;"
                            data-module="govuk-skip-link">
                            Skip to edit page
                        </a>
                    </div>

                    <div class="govuk-tabs__panel" id="tab-two">
                        <!-- Error Messages Content -->
                        <p class="govuk-body-s" style="margin-bottom: 30px; border-bottom: #008938 1px;">
                            <a href="#" class="govuk-link govuk-link--no-visited-state" rel="noreferrer noopener"
                                target="_blank">
                                Preview error messages in a new tab
                            </a>
                        </p>
                        <div class="govuk-error-summary" data-disable-auto-focus="true">
                            <h2 class="govuk-error-summary__title">There is a problem</h2>
                            <ul class="govuk-list govuk-error-summary__list" id="error-messages-list">
                                <!-- Dynamic error messages will be inserted here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("Precise Location JavaScript Loaded");

        // DOM Elements for dynamic updates
        const domElements = {
            questionLabelInputPreciseLocation: document.getElementById('question-label-input-precise-location'),
            questionLabelLegend: document.getElementById('question-label-legend'),
            hintTextInputPreciseLocation: document.getElementById('hint-text-input-precise-location'),
            hintTextOutput: document.getElementById('hint-text-output'),
            makeOptionalPreciseLocation: document.querySelector('input[name="additionalSettings"][value="make-optional"]'),
            helpTextCheckbox: document.querySelector('input[name="additionalSettings"][value="add-help-text"]'),
            helpTextInputPreciseLocation: document.getElementById('help-text-input-precise-location'),
            helpComponentPreview: document.getElementById('help-component-preview'),
            helpContent: document.getElementById('help-content'),
        };

        // Initialize event listeners for dynamic updates
        initializeEventListeners();

        // Function to update preview based on location format
        function updateLocationPreview(selectedFormat) {
            console.log("Updating preview for location format:", selectedFormat);
            const previewContainer = document.getElementById("coordinate-inputs-preview");
            const emptyStateMessage = document.getElementById("empty-state-message");

            if (!previewContainer) return;

            // Hide empty state message when showing content
            if (emptyStateMessage) {
                emptyStateMessage.style.display = 'none';
            }

            let previewHTML = "";

            switch (selectedFormat) {
                case "easting_northing":
                    previewHTML = `
            <div class="govuk-form-group">
              <fieldset class="govuk-fieldset row-prototype-coordinate-input" role="group">
                <legend class="govuk-fieldset__legend govuk-fieldset__legend--l" id="question-label-legend">
                  Question
                </legend>
                <div class="govuk-hint" id="hint-text-output">For example. Easting: 248741, Northing: 63688</div>
                <div class="govuk-date-input row-prototype-coordinate-input" id="easting-northing-preview">
                  <div class="govuk-date-input__item govuk-!-margin-bottom-2">
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="preview-easting">Easting</label>
                      <input class="govuk-input govuk-input--width-5" id="preview-easting" name="easting" type="text" inputmode="numeric">
                    </div>
                  </div>
                  <div class="govuk-date-input__item govuk-!-margin-bottom-2">
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="preview-northing">Northing</label>
                      <input class="govuk-input govuk-input--width-5" id="preview-northing" name="northing" type="text" inputmode="numeric">
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          `;
                    break;
                case "field_number":
                    previewHTML = `
            <div class="govuk-form-group">
              <fieldset class="govuk-fieldset row-prototype-coordinate-input" role="group">
                <legend class="govuk-fieldset__legend govuk-fieldset__legend--l" id="question-label-legend">
                  Question
                </legend>
                <div class="govuk-hint" id="hint-text-output">Must be 10 characters like NG12345678</div>
                <div class="govuk-date-input row-prototype-coordinate-input" id="field-number-preview">
                  <div class="govuk-date-input__item govuk-!-margin-bottom-2">
                    <div class="govuk-form-group">
                      <input class="govuk-input govuk-input--width-10" id="preview-field-number" name="fieldNumber" type="text" inputmode="text">
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          `;
                    break;
                case "os_grid_number":
                    // OS grid reference - always single input box (6-figure)
                    previewHTML = `
              <div class="govuk-form-group govuk-!-margin-bottom-2">
                <fieldset class="govuk-fieldset" role="group">
                  <legend class="govuk-fieldset__legend govuk-fieldset__legend--l" id="question-label-legend">Question</legend>
                  <div class="govuk-hint" id="hint-text-output">Must be between 8 and 12 characters like TQ123456</div>
                  <input class="govuk-input govuk-input--width-10" id="preview-os-grid-single" name="osGridSingle" type="text" inputmode="text">
                </fieldset>
              </div>
            `;
                    break;
                case "longitude_latitude":
                    // Longitude/latitude - always decimal degrees format (6 decimal places latitude, 9 decimal places longitude)
                    previewHTML = `
            <div class="govuk-form-group">
              <fieldset class="govuk-fieldset row-prototype-coordinate-input" role="group">
                <legend class="govuk-fieldset__legend govuk-fieldset__legend--l" id="question-label-legend">
                  Question
                </legend>
                <div class="govuk-hint" id="hint-text-output">For Great Britain, the latitude will be a number between 49.850 and 60.859 and the longitude will be a number between -13.687 and 1.767</div>
                <div class="govuk-date-input row-prototype-coordinate-input" id="longitude-latitude-preview">
                  <div class="govuk-date-input__item govuk-!-margin-bottom-2">
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="preview-latitude">Latitude</label>
                      <div class="govuk-input__wrapper">
                        <input class="govuk-input govuk-input--width-6" id="preview-latitude" name="latitude" type="text" inputmode="numeric">
                        <div class="govuk-input__suffix" aria-hidden="true">°</div>
                      </div>
                    </div>
                  </div>
                  <div class="govuk-date-input__item govuk-!-margin-bottom-2">
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="preview-longitude">Longitude</label>
                      <div class="govuk-input__wrapper">
                        <input class="govuk-input govuk-input--width-9" id="preview-longitude" name="longitude" type="text" inputmode="numeric">
                        <div class="govuk-input__suffix" aria-hidden="true">°</div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          `;
                    break;
                default:
                    previewHTML = `
            <div class="govuk-form-group">
              <label class="govuk-label" for="preview-coordinates">Location coordinates</label>
              <div id="preview-coordinates-hint" class="govuk-hint">Enter precise coordinates</div>
              <input class="govuk-input" id="preview-coordinates" name="coordinates" type="text">
            </div>
          `;
            }

            previewContainer.innerHTML = previewHTML;

            // Re-initialize event listeners for the new DOM elements
            reinitializeEventListeners();

            // Update default hint text when location format changes
            updateDefaultHintText();

            // Update error messages when location format changes
            updateErrorMessages();

            // Update question label to reflect current input value
            updateQuestionLabel();

            // Update help component
            updateHelpComponent();
        }

        // Re-initialize event listeners after preview update
        function reinitializeEventListeners() {
            // Update DOM element references for the new preview elements
            domElements.questionLabelLegend = document.getElementById('question-label-legend');
            domElements.hintTextOutput = document.getElementById('hint-text-output');
            domElements.overrideHintButton = document.getElementById('override-hint-button');
            domElements.useDefaultHintButton = document.getElementById('use-default-hint-button');

            // Re-bind question label updates
            if (domElements.questionLabelInputPreciseLocation && domElements.questionLabelLegend) {
                // Remove existing listeners to avoid duplicates
                const newQuestionInput = domElements.questionLabelInputPreciseLocation.cloneNode(true);
                domElements.questionLabelInputPreciseLocation.parentNode.replaceChild(newQuestionInput, domElements.questionLabelInputPreciseLocation);
                domElements.questionLabelInputPreciseLocation = newQuestionInput;

                domElements.questionLabelInputPreciseLocation.addEventListener('input', updateQuestionLabel);
                applyHighlightOnFocus(domElements.questionLabelInputPreciseLocation, domElements.questionLabelLegend);
            }

            // Re-bind hint text updates
            if (domElements.hintTextInputPreciseLocation && domElements.hintTextOutput) {
                // Remove existing listeners to avoid duplicates
                const newHintInput = domElements.hintTextInputPreciseLocation.cloneNode(true);
                domElements.hintTextInputPreciseLocation.parentNode.replaceChild(newHintInput, domElements.hintTextInputPreciseLocation);
                domElements.hintTextInputPreciseLocation = newHintInput;

                domElements.hintTextInputPreciseLocation.addEventListener('input', updateHintText);
                applyHighlightOnFocus(domElements.hintTextInputPreciseLocation, domElements.hintTextOutput);
            }



            // Re-bind help text checkbox
            if (domElements.helpTextCheckbox) {
                domElements.helpTextCheckbox.addEventListener('change', updateHelpComponent);
            }

            // Re-bind help text input
            if (domElements.helpTextInputPreciseLocation) {
                domElements.helpTextInputPreciseLocation.addEventListener('input', updateHelpComponent);
                applyHighlightOnFocus(domElements.helpTextInputPreciseLocation, domElements.helpContent);
            }

            // Re-bind short description input for error messages
            const shortDescriptionInput = document.getElementById('error-message-input-precise-location');
            if (shortDescriptionInput) {
                shortDescriptionInput.addEventListener('input', updateErrorMessages);
                // Set up highlighting that will work with dynamically created spans
                shortDescriptionInput.addEventListener('focus', function() {
                    const spans = document.querySelectorAll('span[id^="error-dynamic-text"]');
                    spans.forEach(span => span.classList.add('highlight'));
                });
                shortDescriptionInput.addEventListener('blur', function() {
                    const spans = document.querySelectorAll('span[id^="error-dynamic-text"]');
                    spans.forEach(span => span.classList.remove('highlight'));
                });
            }
        }

        // Get the pre-selected location format from session data
        const locationSubType = "{{ data.locationSubType }}";
        if (locationSubType && locationSubType !== "") {
            console.log("Using pre-selected locationSubType:", locationSubType);
            updateLocationPreview(locationSubType);
        } else {
            // Show empty state message when no location format is selected
            console.log("No location format selected, showing empty state");
            showEmptyStateMessage();
        }

        // Set initial default hint text
        updateDefaultHintText();

        // Set initial error messages
        updateErrorMessages();


        // Show empty state message
        function showEmptyStateMessage() {
            const previewContainer = document.getElementById("coordinate-inputs-preview");
            const emptyStateMessage = document.getElementById("empty-state-message");

            if (previewContainer) {
                previewContainer.innerHTML = '';
            }

            if (emptyStateMessage) {
                emptyStateMessage.style.display = 'block';

                // Update the question label in the empty state
                const questionLabel = emptyStateMessage.querySelector('#question-label-legend');

                if (questionLabel) {
                    const questionText = domElements.questionLabelInputPreciseLocation?.value || 'Question';
                    const suffix = domElements.makeOptionalPreciseLocation?.checked ? ' (optional)' : '';
                    questionLabel.textContent = questionText + suffix;
                }
            }
        }

        // Initialize event listeners for dynamic updates
        function initializeEventListeners() {
            // Update question label
            if (domElements.questionLabelInputPreciseLocation && domElements.questionLabelLegend) {
                domElements.questionLabelInputPreciseLocation.addEventListener('input', updateQuestionLabel);
                applyHighlightOnFocus(domElements.questionLabelInputPreciseLocation, domElements.questionLabelLegend);
            }

            // Update hint text
            if (domElements.hintTextInputPreciseLocation && domElements.hintTextOutput) {
                domElements.hintTextInputPreciseLocation.addEventListener('input', updateHintText);
                applyHighlightOnFocus(domElements.hintTextInputPreciseLocation, domElements.hintTextOutput);
            }


            // Update optional state
            if (domElements.makeOptionalPreciseLocation) {
                domElements.makeOptionalPreciseLocation.addEventListener('change', updateQuestionLabel);
            }


            // Help text checkbox
            if (domElements.helpTextCheckbox) {
                domElements.helpTextCheckbox.addEventListener('change', updateHelpComponent);
            }

            // Help text input
            if (domElements.helpTextInputPreciseLocation) {
                domElements.helpTextInputPreciseLocation.addEventListener('input', updateHelpComponent);
                applyHighlightOnFocus(domElements.helpTextInputPreciseLocation, domElements.helpContent);
            }

            // Short description input for error messages
            const shortDescriptionInput = document.getElementById('error-message-input-precise-location');
            if (shortDescriptionInput) {
                shortDescriptionInput.addEventListener('input', updateErrorMessages);
                // Set up highlighting that will work with dynamically created spans
                shortDescriptionInput.addEventListener('focus', function() {
                    const spans = document.querySelectorAll('span[id^="error-dynamic-text"]');
                    console.log('Found spans:', spans.length);
                    spans.forEach(span => {
                        span.classList.add('highlight');
                        console.log('Added highlight to span:', span);
                    });
                });
                shortDescriptionInput.addEventListener('blur', function() {
                    const spans = document.querySelectorAll('span[id^="error-dynamic-text"]');
                    spans.forEach(span => span.classList.remove('highlight'));
                });
            }
        }

        // Update question label with optional suffix
        function updateQuestionLabel() {
            const suffix = domElements.makeOptionalPreciseLocation?.checked ? ' (optional)' : '';
            const questionText = (domElements.questionLabelInputPreciseLocation?.value || 'Question') + suffix;

            if (domElements.questionLabelLegend) {
                domElements.questionLabelLegend.textContent = questionText;
            }

            // Also update empty state message if it's visible
            const emptyStateMessage = document.getElementById("empty-state-message");
            if (emptyStateMessage && emptyStateMessage.style.display !== 'none') {
                const emptyStateQuestionLabel = emptyStateMessage.querySelector('#question-label-legend');
                if (emptyStateQuestionLabel) {
                    emptyStateQuestionLabel.textContent = questionText;
                }
            }
        }

        // Update hint text
        function updateHintText() {
            if (domElements.hintTextOutput) {
                // If custom hint text is provided, use it; otherwise use default
                const customHint = domElements.hintTextInputPreciseLocation?.value || '';
                if (customHint.trim()) {
                    domElements.hintTextOutput.textContent = customHint;
                } else {
                    // Use default hint text based on location format
                    updateDefaultHintText();
                }
            }
        }



        // Update default hint text based on current location format
        function updateDefaultHintText() {
            if (!domElements.hintTextOutput) return;

            // Get the location format from session data
            const locationSubType = "{{ data.locationSubType }}";
            if (!locationSubType) {
                domElements.hintTextOutput.textContent = 'For example. Easting: 248741, Northing: 63688';
                return;
            }

            let defaultHint = '';
            switch (locationSubType) {
                case 'easting_northing':
                    defaultHint = 'For example. Easting: 248741, Northing: 63688';
                    break;
                case 'field_number':
                    defaultHint = 'For Great Britain, the latitude will be a number between 49.850 and 60.859 and he longitude will be a number between -13.687 and 1.767';
                    break;
                case 'os_grid_number':
                    defaultHint = 'An OS grid reference number is made up of 2 letters followed by 10 numbers, for example, SO7394301364';
                    break;
                case 'longitude_latitude':
                    defaultHint = 'For Great Britain, the latitude will be a number between 49.850 and 60.859 and the longitude will be a number between -13.687 and 1.767';
                    break;
                default:
                    defaultHint = 'Easting must be between 0 and 70000. Northing must be between 0 and 1300000.';
            }

            domElements.hintTextOutput.textContent = defaultHint;

            // Also update the hint text input with default text
            if (domElements.hintTextInputPreciseLocation) {
                // Always update with the new default hint text
                domElements.hintTextInputPreciseLocation.value = defaultHint;
            }
        }

        // Update error messages based on current location format
        function updateErrorMessages() {
            const errorMessagesList = document.getElementById('error-messages-list');
            if (!errorMessagesList) return;

            // Get the location format from session data
            const locationSubType = "{{ data.locationSubType }}";
            if (!locationSubType) {
                errorMessagesList.innerHTML = '<li><a class="govuk-error-message"><span class="govuk-visually-hidden">Error:</span>No location format selected</a></li>';
                return;
            }

            // Get short description input value
            const shortDescriptionInput = document.getElementById('error-message-input-precise-location');
            const shortDescription = shortDescriptionInput ? shortDescriptionInput.value.trim() || '[Short description]' : '[Short description]';

            let errorMessages = [];
            switch (locationSubType) {
                case 'easting_northing':
                    errorMessages = [
                        `Enter easting for <span id="error-dynamic-text-east" style="text-transform: lowercase;">${shortDescription}</span>`,
                        `Enter northing for <span id="error-dynamic-text-north" style="text-transform: lowercase;">${shortDescription}</span>`,
                        `Easting for <span id="error-dynamic-text-east-length" style="text-transform: lowercase;">${shortDescription}</span> must be between 1 and 5 digits`,
                        `Northing for <span id="error-dynamic-text-north-length" style="text-transform: lowercase;">${shortDescription}</span> must be between 1 and 7 digits`,
                        `Easting for <span id="error-dynamic-text-east-range" style="text-transform: lowercase;">${shortDescription}</span> must be between 0 and 70000`,
                        `Northing for <span id="error-dynamic-text-north-range" style="text-transform: lowercase;">${shortDescription}</span> must be between 0 and 1300000`
                    ];
                    break;
                case 'field_number':
                    errorMessages = [
                        `Enter National Grid field number for <span id="error-dynamic-text-field" style="text-transform: lowercase;">${shortDescription}</span>`,
                        `Enter a valid National Grid field number for <span id="error-dynamic-text-field-format" style="text-transform: lowercase;">${shortDescription}</span> like NG12345678`,
                        `National Grid field number for <span id="error-dynamic-text-field-length" style="text-transform: lowercase;">${shortDescription}</span> must be 10 characters like NG12345678`
                    ];
                    break;
                case 'os_grid_number':
                    errorMessages = [
                        `Enter OS grid reference for <span id="error-dynamic-text-os" style="text-transform: lowercase;">${shortDescription}</span>`,
                        `Enter a valid OS grid reference for <span id="error-dynamic-text-os-valid" style="text-transform: lowercase;">${shortDescription}</span> like TQ123456`,
                        `OS grid reference for <span id="error-dynamic-text-os-length" style="text-transform: lowercase;">${shortDescription}</span> must be between 8 and 12 characters`,
                        `Grid square must be 2 letters like TQ or SW`,
                        `OS grid reference for <span id="error-dynamic-text-os-range" style="text-transform: lowercase;">${shortDescription}</span> must be within Great Britain`
                    ];
                    break;
                case 'longitude_latitude':
                    errorMessages = [
                        `Enter latitude for <span id="error-dynamic-text-lat" style="text-transform: lowercase;">${shortDescription}</span>`,
                        `Enter longitude for <span id="error-dynamic-text-lon" style="text-transform: lowercase;">${shortDescription}</span>`,
                        `Enter a valid latitude for <span id="error-dynamic-text-lat-format" style="text-transform: lowercase;">${shortDescription}</span> like 51.519450`,
                        `Enter a valid longitude for <span id="error-dynamic-text-lon-format" style="text-transform: lowercase;">${shortDescription}</span> like -0127758`,
                        `Latitude for <span id="error-dynamic-text-lat-range" style="text-transform: lowercase;">${shortDescription}</span> must be between 49 and 60`,
                        `Longitude for <span id="error-dynamic-text-lon-range" style="text-transform: lowercase;">${shortDescription}</span> must be between -9 and 2`
                    ];
                    break;
                default:
                    errorMessages = [
                        `Select a location format`
                    ];
            }

            // Generate HTML for error messages
            const errorHTML = errorMessages.map(error =>
                `<li><a class="govuk-error-message"><span class="govuk-visually-hidden">Error:</span>${error}</a></li>`
            ).join('');

            errorMessagesList.innerHTML = errorHTML;

            // Apply highlighting if the short description input is focused
            const shortDescInput = document.getElementById('error-message-input-precise-location');
            if (shortDescInput && document.activeElement === shortDescInput) {
                const spans = document.querySelectorAll('span[id^="error-dynamic-text"]');
                spans.forEach(span => span.classList.add('highlight'));
            }
        }

        // Update help component based on checkbox and content
        function updateHelpComponent() {
            if (!domElements.helpComponentPreview || !domElements.helpContent) return;

            // Check if checkbox is checked
            const isChecked = domElements.helpTextCheckbox ? domElements.helpTextCheckbox.checked : false;
            const customHelpText = domElements.helpTextInputPreciseLocation ? domElements.helpTextInputPreciseLocation.value.trim() : '';

            if (isChecked) {
                // Show help component
                domElements.helpComponentPreview.style.display = 'block';

                if (customHelpText) {
                    // Use custom markdown content
                    const htmlContent = convertMarkdownToHtml(customHelpText);
                    domElements.helpContent.innerHTML = htmlContent;
                } else {
                    // Show placeholder content when checkbox is checked but no help text
                    domElements.helpContent.innerHTML = '<p class="govuk-body">Help text</p>';
                }
            } else {
                // Hide help component when checkbox not checked
                domElements.helpComponentPreview.style.display = 'none';
            }
        }



        // Basic markdown to HTML converter
        function convertMarkdownToHtml(markdown) {
            let html = markdown;

            // Convert links [text](url) to HTML links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="govuk-link" target="_blank" rel="noreferrer noopener">$1 (opens in new tab)</a>');

            const lines = html.split('\n');
            let result = [];
            let inList = false;
            let listType = null; // 'ul' or 'ol'

            const openList = (type) => {
                listType = type;
                const listClass = type === 'ol' ? 'govuk-list govuk-list--number' : 'govuk-list govuk-list--bullet';
                result.push(`<${type} class="${listClass}">`);
                inList = true;
            };

            const closeList = () => {
                if (inList && listType) {
                    result.push(`</${listType}>`);
                    inList = false;
                    listType = null;
                }
            };

            for (let i = 0; i < lines.length; i++) {
                const rawLine = lines[i];
                const line = rawLine.trim();

                if (!line) {
                    // Blank line: close any open list and skip
                    closeList();
                    continue;
                }

                const isBullet = line.startsWith('- ');
                const isNumbered = /^\d+\.\s+/.test(line);

                if (isBullet) {
                    if (!inList || listType !== 'ul') {
                        closeList();
                        openList('ul');
                    }
                    result.push(`<li>${line.substring(2)}</li>`);
                    continue;
                }

                if (isNumbered) {
                    if (!inList || listType !== 'ol') {
                        closeList();
                        openList('ol');
                    }
                    const itemText = line.replace(/^\d+\.\s+/, '');
                    result.push(`<li>${itemText}</li>`);
                    continue;
                }

                // Regular paragraph text
                closeList();
                result.push(`<p class="govuk-body">${line}</p>`);
            }

            // Close any remaining open list
            closeList();

            return result.join('\n');
        }


        // Apply focus/blur highlighting
        function applyHighlightOnFocus(inputElement, targetElement) {
            if (inputElement && targetElement) {
                inputElement.addEventListener('focus', function () {
                    if (targetElement.length !== undefined) {
                        // Handle NodeList (multiple elements)
                        targetElement.forEach(target => target.classList.add('highlight'));
                    } else {
                        // Handle single element
                        targetElement.classList.add('highlight');
                    }
                });
                inputElement.addEventListener('blur', function () {
                    if (targetElement.length !== undefined) {
                        // Handle NodeList (multiple elements)
                        targetElement.forEach(target => target.classList.remove('highlight'));
                    } else {
                        // Handle single element
                        targetElement.classList.remove('highlight');
                    }
                });
            }
        }
    });

</script>

<style>
    .preview-content .govuk-form-group {
        margin-bottom: 15px;
    }

    .preview-content .govuk-form-group:last-child {
        margin-bottom: 0;
    }

    .preview-content .govuk-body {
        display: block;
        margin: 0 0 15px 0;
    }

    /* Ensure list items are properly indented within preview */
    .preview-content .govuk-list {
        margin: 0 0 15px 20px;
        padding-left: 20px;
    }

    .preview-content .govuk-list li {
        margin-bottom: 5px;
    }

    /* Ensure numbered list has consistent styling with GOV.UK */
    .preview-content .govuk-list--number {
        list-style: decimal;
    }

    /* Using exact same structure as precise.html - no custom CSS needed */

    /* Highlight preview elements on focus - matching other question types */
    .highlight {
        background-color: #ffe5cc;
        border-bottom: 2px solid #ffb266;
    }

    /* Ensure highlighted spans have black text */
    .highlight span {
        color: #000000 !important;
    }

    /* More specific targeting for error message spans */
    .govuk-error-message .highlight span {
        color: #000000 !important;
    }

    /* Even more specific for spans with error-dynamic-text IDs */
    span[id^="error-dynamic-text"].highlight {
        color: #000000 !important;
    }

    /* Force black text on highlighted spans in error messages */
    .govuk-error-message span.highlight {
        color: #000000 !important;
        background-color: #ffe5cc !important;
        border-bottom: 2px solid #ffb266 !important;
    }

    /* Left border container for preview panel - matching other question types */
    .border-left-container {
        border-left: 10px solid #ffb266;
        padding-left: 20px;
    }
</style>

{% endblock %}